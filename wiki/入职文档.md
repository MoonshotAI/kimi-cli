# Kimi CLI 项目入职文档

## 目录

- [项目概述](#项目概述)
- [技术栈](#技术栈)
- [项目架构](#项目架构)
- [开发环境搭建](#开发环境搭建)
- [核心概念](#核心概念)
- [代码结构](#代码结构)
- [开发流程](#开发流程)
- [测试指南](#测试指南)
- [常见任务](#常见任务)
- [故障排查](#故障排查)
- [参考资料](#参考资料)

---

## 项目概述

**Kimi CLI** 是一个基于 AI 的交互式命令行工具，专门用于软件工程任务和终端操作。它提供了一个智能代理系统，可以通过自然语言与开发者交互，执行代码编写、文件操作、命令执行等任务。

### 核心特性

- **Shell 模式**：类似 Shell 的交互界面，支持直接执行 Shell 命令
- **Zsh 集成**：可以与 Zsh 集成，增强 Shell 体验
- **Agent Client Protocol (ACP) 支持**：支持 ACP 协议，可与兼容的编辑器/IDE 集成
- **MCP 支持**：支持 Model Context Protocol，可连接外部工具服务
- **多 UI 模式**：Shell（交互式）、Print（非交互式）、ACP（服务器模式）、Wire（实验性）
- **工具系统**：模块化的工具架构，支持自定义工具开发
- **会话管理**：支持会话持久化，可以继续之前的对话

### 项目状态

- **当前版本**：0.54
- **Python 版本要求**：3.13+
- **状态**：技术预览阶段（Technical Preview）

---

## 技术栈

### 核心依赖

- **Python**: 3.13+
- **包管理**: uv（现代 Python 包管理器）
- **构建系统**: uv_build
- **CLI 框架**: Typer
- **LLM 集成**: kosong（自定义 LLM 框架）
- **异步运行时**: asyncio
- **测试框架**: pytest + pytest-asyncio
- **代码质量**: 
  - ruff（代码格式化和 linting）
  - pyright（类型检查）
- **打包工具**: PyInstaller（用于构建独立可执行文件）

### 主要第三方库

- `agent-client-protocol`: ACP 协议支持
- `aiofiles`: 异步文件操作
- `aiohttp`: 异步 HTTP 客户端
- `typer`: CLI 框架
- `kosong`: LLM 框架
- `loguru`: 结构化日志
- `prompt-toolkit`: 交互式命令行界面
- `rich`: 终端富文本渲染
- `ripgrepy`: ripgrep 的 Python 绑定
- `pydantic`: 数据验证和配置管理
- `fastmcp`: MCP 协议支持

---

## 项目架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                      CLI Entry Point                     │
│                    (cli.py, app.py)                      │
└────────────────────┬────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
    ┌────▼────┐            ┌─────▼─────┐
    │  Shell  │            │   Print   │
    │   UI    │            │    UI     │
    └────┬────┘            └─────┬─────┘
         │                       │
         └───────────┬───────────┘
                     │
              ┌──────▼──────┐
              │  KimiSoul   │
              │ (核心引擎)   │
              └──────┬──────┘
                     │
         ┌───────────┼───────────┐
         │           │           │
    ┌────▼────┐ ┌───▼───┐ ┌────▼────┐
    │ Context │ │ Agent │ │ Runtime │
    │(上下文)  │ │(代理) │ │(运行时) │
    └─────────┘ └───┬───┘ └────┬────┘
                    │          │
              ┌─────▼──────────▼─────┐
              │     Toolset          │
              │    (工具集合)         │
              └─────┬───────────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
   ┌────▼────┐ ┌────▼────┐ ┌───▼────┐
   │  Bash   │ │  File   │ │  Web   │
   │  Tools  │ │  Tools  │ │ Tools  │
   └─────────┘ └─────────┘ └────────┘
```

### 核心组件

#### 1. Agent System（代理系统）

**位置**: `src/kimi_cli/agentspec.py`, `src/kimi_cli/soul/agent.py`

- **功能**: 基于 YAML 的代理配置系统
- **特性**:
  - YAML 格式的代理规范文件
  - 系统提示词模板化，支持内置参数
  - 工具加载和依赖注入
  - 子代理支持，用于任务委派
  - 代理继承机制（`extend` 字段）

**示例代理配置** (`src/kimi_cli/agents/default/agent.yaml`):

```yaml
version: 1
agent:
  name: ""
  system_prompt_path: ./system.md
  system_prompt_args:
    ROLE_ADDITIONAL: ""
  tools:
    - "kimi_cli.tools.bash:Bash"
    - "kimi_cli.tools.file:ReadFile"
    - "kimi_cli.tools.file:WriteFile"
    # ...
  subagents:
    coder:
      path: ./sub.yaml
      description: "Good at general software engineering tasks."
```

#### 2. Soul Architecture（核心执行引擎）

**位置**: `src/kimi_cli/soul/`

**核心类**:

- **`KimiSoul`** (`kimisoul.py`): 主执行引擎
  - 管理代理执行循环
  - 处理工具调用
  - 管理上下文压缩
  - 支持思考模式（thinking mode）

- **`Context`** (`context.py`): 会话历史管理
  - 持久化对话历史
  - 恢复会话状态
  - 消息压缩和清理

- **`DenwaRenji`** (`denwarenji.py`): 工具通信中心
  - 工具调用协调
  - 事件驱动架构
  - 重试机制

- **`Runtime`** (`runtime.py`): 运行时环境
  - LLM 配置
  - 会话管理
  - 审批机制
  - 配置管理

#### 3. UI Modes（用户界面模式）

**位置**: `src/kimi_cli/ui/`

- **Shell** (`shell/`): 交互式终端界面（默认）
  - 基于 `prompt-toolkit` 的交互式界面
  - 支持快捷键和命令补全
  - 模式切换（Ctrl-X）
  - 元命令支持（`/help`, `/setup`, `/clear` 等）

- **Print** (`print/`): 非交互式模式
  - 用于脚本和自动化
  - 支持 JSON 输入/输出格式
  - 自动批准所有操作（YOLO 模式）

- **ACP** (`acp/`): Agent Client Protocol 服务器
  - 实现 ACP 协议
  - 可与编辑器/IDE 集成（如 Zed）

- **Wire** (`wire/`): Wire 协议服务器（实验性）
  - 本地 IPC 通信
  - 基于 stdio 的通信协议

#### 4. Tool System（工具系统）

**位置**: `src/kimi_cli/tools/`

**架构特点**:
- 基于 `kosong.tooling` 框架
- 依赖注入机制
- 模块化设计
- 支持 MCP 工具集成

**内置工具**:

| 工具类别 | 工具名称 | 功能描述 |
|---------|---------|---------|
| Shell | `Bash` / `CMD` | 执行 Shell 命令 |
| File | `ReadFile` | 读取文件内容 |
| File | `WriteFile` | 写入文件 |
| File | `Glob` | 文件模式匹配 |
| File | `Grep` | 内容搜索（正则表达式） |
| File | `StrReplaceFile` | 字符串替换 |
| File | `PatchFile` | 应用补丁 |
| Web | `SearchWeb` | 网络搜索 |
| Web | `FetchURL` | 下载网页内容 |
| Task | `Task` | 委派给子代理 |
| Other | `SendDMail` | 时间旅行消息系统 |
| Other | `Think` | 内部推理工具 |
| Other | `SetTodoList` | 任务管理 |

**工具开发模式**:

```python
from kosong.tooling import CallableTool2, ToolReturnType
from pydantic import BaseModel, Field

class Params(BaseModel):
    param1: str = Field(description="参数描述")

class MyTool(CallableTool2[Params]):
    name: str = "MyTool"
    description: str = "工具描述"
    params: type[Params] = Params

    def __init__(self, approval: Approval, **kwargs):
        super().__init__(**kwargs)
        self._approval = approval

    async def __call__(self, params: Params) -> ToolReturnType:
        # 工具实现
        return ToolResultBuilder().ok("成功")
```

---

## 开发环境搭建

### 前置要求

1. **Python 3.13+**
   ```bash
   python --version  # 检查版本
   ```

2. **安装 uv**
   ```bash
   curl -LsSf https://astral.sh/uv/install.sh | sh
   # 或使用 pip
   pip install uv
   ```

### 初始化开发环境

1. **克隆仓库**
   ```bash
   git clone https://github.com/MoonshotAI/kimi-cli.git
   cd kimi-cli
   ```

2. **准备开发环境**
   ```bash
   make prepare
   # 或手动执行
   uv sync --frozen
   ```

3. **验证安装**
   ```bash
   uv run kimi --help
   ```

### 开发工具配置

**VS Code 推荐配置**:
- Python 扩展
- Pylance（类型检查）
- Ruff 扩展（代码格式化）

**PyCharm 配置**:
- 设置 Python 解释器为项目虚拟环境
- 启用类型检查
- 配置 ruff 作为外部工具

---

## 核心概念

### 1. Session（会话）

**位置**: `src/kimi_cli/session.py`

会话代表一次用户交互周期，包含：
- 会话 ID（唯一标识）
- 工作目录
- 历史文件路径
- 会话元数据

**会话生命周期**:
```python
# 创建新会话
session = Session.create(work_dir)

# 继续之前的会话
session = Session.continue_(work_dir)

# 会话历史文件
history_file = session.history_file  # ~/.kimi/sessions/{session_id}/history.jsonl
```

### 2. Agent（代理）

代理是 AI 助手的具体实例，包含：
- **名称**: 代理标识
- **系统提示词**: 定义代理行为和能力
- **工具集**: 可用的工具列表
- **子代理**: 可委派任务的子代理

**代理加载流程**:
1. 读取 YAML 配置文件
2. 解析系统提示词模板
3. 加载工具类
4. 注入依赖（Runtime, Approval 等）
5. 创建 Agent 实例

### 3. Context（上下文）

上下文管理对话历史，包括：
- 用户消息
- 助手回复
- 工具调用结果
- 系统消息

**上下文压缩**:
- 当上下文接近模型限制时自动压缩
- 保留重要消息（用户消息、工具结果）
- 合并连续的助手消息

### 4. Tool（工具）

工具是代理可以调用的功能单元：

**工具接口**:
```python
class Tool(Protocol):
    name: str
    description: str
    params: type[BaseModel]
    
    async def __call__(self, params: Params) -> ToolReturnType:
        ...
```

**工具依赖注入**:
- `Approval`: 审批机制
- `Runtime`: 运行时环境
- `Session`: 会话信息
- `Config`: 配置信息
- `DenwaRenji`: 工具通信中心

### 5. Approval（审批机制）

**位置**: `src/kimi_cli/soul/approval.py`

审批机制控制工具调用的执行：
- 默认模式：需要用户确认
- YOLO 模式（`--yolo`）：自动批准所有操作
- Print 模式：隐式启用 YOLO 模式

### 6. Runtime（运行时）

**位置**: `src/kimi_cli/soul/runtime.py`

运行时环境提供：
- LLM 实例
- 配置信息
- 会话管理
- 审批机制
- 工具通信中心

---

## 代码结构

### 目录结构详解

```
kimi-cli/
├── src/kimi_cli/              # 主源代码目录
│   ├── __init__.py
│   ├── cli.py                  # CLI 入口点
│   ├── app.py                  # 应用主类
│   ├── config.py               # 配置管理
│   ├── agentspec.py            # 代理规范解析
│   ├── llm.py                  # LLM 集成
│   ├── session.py              # 会话管理
│   ├── exception.py            # 异常定义
│   │
│   ├── agents/                 # 默认代理配置
│   │   └── default/
│   │       ├── agent.yaml      # 主代理配置
│   │       ├── sub.yaml        # 子代理配置
│   │       └── system.md       # 系统提示词
│   │
│   ├── soul/                   # 核心执行引擎
│   │   ├── __init__.py
│   │   ├── kimisoul.py         # 主执行引擎
│   │   ├── agent.py            # 代理加载
│   │   ├── context.py          # 上下文管理
│   │   ├── denwarenji.py       # 工具通信中心
│   │   ├── runtime.py          # 运行时环境
│   │   ├── approval.py         # 审批机制
│   │   ├── compaction.py       # 上下文压缩
│   │   ├── message.py           # 消息处理
│   │   └── toolset.py          # 工具集管理
│   │
│   ├── tools/                   # 工具实现
│   │   ├── __init__.py
│   │   ├── utils.py             # 工具工具函数
│   │   ├── mcp.py               # MCP 集成
│   │   ├── bash/                # Shell 命令工具
│   │   ├── file/                # 文件操作工具
│   │   ├── web/                 # 网络工具
│   │   ├── task/                # 任务委派工具
│   │   ├── dmail/               # 时间旅行消息
│   │   ├── think/               # 思考工具
│   │   └── todo/                # 任务管理工具
│   │
│   ├── ui/                      # 用户界面
│   │   ├── shell/               # Shell 模式
│   │   ├── print/               # Print 模式
│   │   ├── acp/                 # ACP 服务器
│   │   └── wire/                # Wire 服务器
│   │
│   └── utils/                   # 工具函数
│       ├── logging.py           # 日志配置
│       ├── path.py              # 路径处理
│       ├── string.py            # 字符串处理
│       └── rich/                # Rich 渲染
│
├── tests/                       # 测试代码
│   ├── conftest.py              # pytest 配置
│   ├── test_*.py                # 单元测试
│   └── ...
│
├── tests_ai/                    # AI 测试脚本
│   └── scripts/
│
├── wiki/                        # 文档目录
│   └── 入职文档.md              # 本文档
│
├── pyproject.toml               # 项目配置
├── Makefile                     # 构建脚本
├── README.md                    # 项目说明
├── CHANGELOG.md                 # 更新日志
├── CONTRIBUTING.md              # 贡献指南
└── AGENTS.md                    # 代理说明
```

### 关键文件说明

#### `cli.py`
- CLI 入口点
- 参数解析和验证
- UI 模式选择
- 会话创建/恢复

#### `app.py`
- `KimiCLI` 主类
- 不同 UI 模式的运行方法
- 环境上下文管理

#### `soul/kimisoul.py`
- 核心执行循环
- 工具调用处理
- 上下文压缩
- 错误处理和重试

#### `config.py`
- 配置加载和验证
- 默认配置生成
- 配置持久化

---

## 开发流程

### 代码规范

**代码风格**:
- 行长度限制：100 字符
- 格式化工具：ruff
- 类型检查：pyright
- 导入排序：isort

**Ruff 规则**:
- `E`: pycodestyle
- `F`: Pyflakes
- `UP`: pyupgrade
- `B`: flake8-bugbear
- `SIM`: flake8-simplify
- `I`: isort

### 常用命令

```bash
# 格式化代码
make format
# 或
uv run ruff check --fix && uv run ruff format

# 运行 linting 和类型检查
make check
# 或
uv run ruff check && uv run ruff format --check && uv run pyright

# 运行测试
make test
# 或
uv run pytest tests -vv

# 运行开发版本
uv run kimi

# 构建独立可执行文件
make build
# 或
uv run pyinstaller kimi.spec
```

### 开发工作流

1. **创建功能分支**
   ```bash
   git checkout -b feature/my-feature
   ```

2. **编写代码**
   - 遵循代码规范
   - 添加类型注解
   - 编写文档字符串

3. **运行检查**
   ```bash
   make format
   make check
   make test
   ```

4. **提交代码**
   ```bash
   git add .
   git commit -m "feat: 添加新功能"
   ```

5. **创建 Pull Request**
   - 确保所有检查通过
   - 添加清晰的描述
   - 关联相关 Issue

### 代码审查要点

- **代码质量**: 代码应该清晰、可维护
- **测试覆盖**: 新功能应该有相应的测试
- **文档更新**: 更新相关文档
- **向后兼容**: 考虑对现有功能的影响
- **性能影响**: 评估性能影响

---

## 测试指南

### 测试结构

测试文件遵循 `test_*.py` 命名模式，按组件组织：

- `test_load_agent.py`: 代理加载测试
- `test_bash.py`: Shell 命令执行测试
- `test_*_file.py`: 文件操作工具测试
- `test_task_subagents.py`: 子代理功能测试
- `test_config.py`: 配置管理测试

### 运行测试

```bash
# 运行所有测试
make test

# 运行特定测试文件
uv run pytest tests/test_bash.py -vv

# 运行特定测试函数
uv run pytest tests/test_bash.py::test_bash_command -vv

# 显示覆盖率
uv run pytest tests --cov=kimi_cli --cov-report=html
```

### 测试模式

**单元测试**:
- 测试单个组件功能
- 使用 mock 隔离依赖
- 快速执行

**集成测试**:
- 测试组件间交互
- 使用真实依赖（如 LLM mock）
- 验证端到端流程

### 测试 Fixtures

**位置**: `tests/conftest.py`

常用 fixtures:
- `agent`: 加载的代理实例
- `runtime`: 运行时环境
- `session`: 测试会话
- `mock_llm`: Mock LLM 提供者

### 编写测试示例

```python
import pytest
from kimi_cli.tools.bash import Bash

@pytest.mark.asyncio
async def test_bash_command(approval):
    tool = Bash(approval=approval)
    result = await tool(Params(command="echo hello"))
    assert result.success
    assert "hello" in result.content
```

---

## 常见任务

### 1. 添加新工具

**步骤**:

1. **创建工具目录和文件**
   ```bash
   mkdir -p src/kimi_cli/tools/my_tool
   touch src/kimi_cli/tools/my_tool/__init__.py
   touch src/kimi_cli/tools/my_tool/my_tool.md
   ```

2. **实现工具类**
   ```python
   # src/kimi_cli/tools/my_tool/__init__.py
   from kosong.tooling import CallableTool2
   from pydantic import BaseModel, Field
   
   class Params(BaseModel):
       input: str = Field(description="输入参数")
   
   class MyTool(CallableTool2[Params]):
       name: str = "MyTool"
       description: str = "工具描述"
       params: type[Params] = Params
       
       async def __call__(self, params: Params) -> ToolReturnType:
           # 实现逻辑
           return ToolResultBuilder().ok("结果")
   ```

3. **添加到代理配置**
   ```yaml
   # src/kimi_cli/agents/default/agent.yaml
   tools:
     - "kimi_cli.tools.my_tool:MyTool"
   ```

4. **编写测试**
   ```python
   # tests/test_my_tool.py
   @pytest.mark.asyncio
   async def test_my_tool(approval):
       tool = MyTool(approval=approval)
       result = await tool(Params(input="test"))
       assert result.success
   ```

### 2. 修改系统提示词

**位置**: `src/kimi_cli/agents/default/system.md`

**系统提示词变量**:
- `${KIMI_NOW}`: 当前时间戳
- `${KIMI_WORK_DIR}`: 工作目录路径
- `${KIMI_WORK_DIR_LS}`: 目录列表
- `${KIMI_AGENTS_MD}`: AGENTS.md 内容

**自定义变量**:
在 `agent.yaml` 中定义：
```yaml
system_prompt_args:
  CUSTOM_VAR: "自定义值"
```

### 3. 添加新的 UI 模式

1. **创建 UI 目录**
   ```bash
   mkdir -p src/kimi_cli/ui/my_ui
   touch src/kimi_cli/ui/my_ui/__init__.py
   ```

2. **实现 UI 类**
   ```python
   class MyUI:
       def __init__(self, soul: KimiSoul):
           self._soul = soul
       
       async def run(self) -> bool:
           # UI 实现
           pass
   ```

3. **在 `app.py` 中添加运行方法**
   ```python
   async def run_my_ui_mode(self) -> bool:
       from kimi_cli.ui.my_ui import MyUI
       with self._app_env():
           app = MyUI(self._soul)
           return await app.run()
   ```

4. **在 `cli.py` 中添加 CLI 选项**

### 4. 调试问题

**启用调试日志**:
```bash
uv run kimi --debug
```

**日志位置**:
- `~/.kimi/logs/kimi.log`

**调试技巧**:
- 使用 `/debug` 元命令查看上下文状态
- 检查会话历史文件
- 查看 LLM 请求/响应日志

### 5. 配置 LLM 提供商

**配置文件**: `~/.kimi/config.json`

**示例配置**:
```json
{
  "default_model": "kimi-latest",
  "models": {
    "kimi-latest": {
      "provider": "kimi",
      "model": "moonshot-v1-8k",
      "max_context_size": 8000
    }
  },
  "providers": {
    "kimi": {
      "type": "kimi",
      "base_url": "https://api.moonshot.cn/v1",
      "api_key": "your-api-key"
    }
  }
}
```

**环境变量覆盖**:
- `KIMI_BASE_URL`: 覆盖 base_url
- `KIMI_API_KEY`: 覆盖 api_key
- `KIMI_MODEL_NAME`: 覆盖模型名称

---

## 故障排查

### 常见问题

#### 1. 导入错误

**问题**: `ModuleNotFoundError`

**解决方案**:
- 确保已运行 `uv sync`
- 检查 Python 版本（需要 3.13+）
- 验证虚拟环境激活

#### 2. 配置错误

**问题**: `ConfigError`

**解决方案**:
- 检查 `~/.kimi/config.json` 格式
- 验证 JSON 语法
- 检查必需字段

#### 3. 工具加载失败

**问题**: `Invalid tools: [...]`

**解决方案**:
- 检查工具类路径是否正确
- 验证工具类是否继承正确的基类
- 检查工具依赖注入是否正确

#### 4. LLM API 错误

**问题**: API 调用失败

**解决方案**:
- 检查 API 密钥配置
- 验证网络连接
- 查看日志文件获取详细错误信息
- 检查 API 配额和限制

#### 5. 会话恢复失败

**问题**: 无法继续之前的会话

**解决方案**:
- 检查会话历史文件是否存在
- 验证工作目录是否匹配
- 检查文件权限

### 调试命令

```bash
# 查看版本信息
uv run kimi --version

# 启用详细输出
uv run kimi --verbose

# 启用调试日志
uv run kimi --debug

# 查看帮助
uv run kimi --help

# 在 Shell 模式中使用调试命令
/setup    # 配置 LLM
/debug    # 查看上下文状态
/clear    # 清空上下文
/version  # 查看版本
```

---

## 参考资料

### 官方文档

- **项目 README**: `README.md`
- **更新日志**: `CHANGELOG.md`
- **贡献指南**: `CONTRIBUTING.md`
- **代理说明**: `AGENTS.md`

### 外部资源

- **uv 文档**: https://docs.astral.sh/uv/
- **Typer 文档**: https://typer.tiangolo.com/
- **kosong 框架**: 项目内部 LLM 框架
- **Agent Client Protocol**: https://github.com/agentclientprotocol/agent-client-protocol
- **MCP 协议**: Model Context Protocol 规范

### 代码示例

- **工具实现**: `src/kimi_cli/tools/bash/__init__.py`
- **代理配置**: `src/kimi_cli/agents/default/agent.yaml`
- **UI 实现**: `src/kimi_cli/ui/shell/console.py`
- **测试示例**: `tests/test_bash.py`

### 相关项目

- **zsh-kimi-cli**: Zsh 集成插件
- **Kimi API**: LLM API 服务

---

## 快速开始检查清单

- [ ] 安装 Python 3.13+
- [ ] 安装 uv 包管理器
- [ ] 克隆项目仓库
- [ ] 运行 `make prepare` 准备环境
- [ ] 运行 `make test` 验证安装
- [ ] 阅读 `README.md` 了解基本用法
- [ ] 运行 `uv run kimi` 体验工具
- [ ] 阅读核心代码文件（`cli.py`, `app.py`, `soul/kimisoul.py`）
- [ ] 查看测试文件了解代码风格
- [ ] 配置开发环境（编辑器、格式化工具）

---

## 下一步

1. **熟悉代码库**: 从核心文件开始，逐步了解各个模块
2. **运行示例**: 尝试运行不同的 UI 模式和工具
3. **阅读测试**: 通过测试代码理解功能实现
4. **小改动开始**: 从修复小 bug 或改进文档开始
5. **参与讨论**: 在 Issue 中参与讨论，了解项目方向

---

**文档版本**: 1.0  
**最后更新**: 2025-01-XX  
**维护者**: Kimi CLI 团队

