# Kimi CLI 快速参考

## 常用命令

```bash
# 开发环境准备
make prepare              # 同步依赖
make format              # 格式化代码
make check               # 运行 linting 和类型检查
make test                # 运行测试
make build               # 构建可执行文件

# 运行工具
uv run kimi              # 运行 Shell 模式
uv run kimi --print      # 运行 Print 模式
uv run kimi --acp        # 运行 ACP 服务器
uv run kimi --debug      # 启用调试日志
uv run kimi --yolo       # 自动批准所有操作
```

## 项目结构速查

```
src/kimi_cli/
├── cli.py              # CLI 入口
├── app.py              # 应用主类
├── config.py           # 配置管理
├── agentspec.py        # 代理规范
├── agents/             # 代理配置
├── soul/               # 核心引擎
├── tools/              # 工具实现
└── ui/                 # UI 模式
```

## 核心类速查

| 类名 | 位置 | 功能 |
|------|------|------|
| `KimiCLI` | `app.py` | 应用主类 |
| `KimiSoul` | `soul/kimisoul.py` | 核心执行引擎 |
| `Context` | `soul/context.py` | 上下文管理 |
| `Agent` | `soul/agent.py` | 代理实例 |
| `Runtime` | `soul/runtime.py` | 运行时环境 |
| `Session` | `session.py` | 会话管理 |

## 配置文件位置

- **用户配置**: `~/.kimi/config.json`
- **会话历史**: `~/.kimi/sessions/{session_id}/history.jsonl`
- **日志文件**: `~/.kimi/logs/kimi.log`

## Shell 模式快捷键

- `Ctrl-X`: 切换 Shell/Agent 模式
- `Ctrl-C`: 中断当前步骤
- `Ctrl-D`: 退出
- `Ctrl-J` / `Alt-Enter`: 插入新行
- `Ctrl-W`: 删除单词

## Shell 模式元命令

- `/help`: 显示帮助
- `/setup`: 配置 LLM
- `/clear`: 清空上下文
- `/debug`: 查看上下文状态
- `/version`: 显示版本
- `/update`: 检查更新
- `/reload`: 重新加载配置
- `/yolo`: 启用 YOLO 模式
- `/feedback`: 反馈问题

## 工具开发模板

```python
from kosong.tooling import CallableTool2, ToolReturnType
from pydantic import BaseModel, Field
from kimi_cli.tools.utils import ToolResultBuilder

class Params(BaseModel):
    param: str = Field(description="参数描述")

class MyTool(CallableTool2[Params]):
    name: str = "MyTool"
    description: str = "工具描述"
    params: type[Params] = Params

    def __init__(self, approval: Approval, **kwargs):
        super().__init__(**kwargs)
        self._approval = approval

    async def __call__(self, params: Params) -> ToolReturnType:
        if not await self._approval.request(self.name, "action", "description"):
            return ToolRejectedError()
        
        # 实现逻辑
        return ToolResultBuilder().ok("成功")
```

## 代理配置模板

```yaml
version: 1
agent:
  name: "MyAgent"
  system_prompt_path: ./system.md
  system_prompt_args:
    CUSTOM_VAR: "value"
  tools:
    - "kimi_cli.tools.bash:Bash"
    - "kimi_cli.tools.file:ReadFile"
  exclude_tools:
    - "SomeTool"
  subagents:
    sub:
      path: ./sub.yaml
      description: "子代理描述"
```

## 系统提示词变量

- `${KIMI_NOW}`: 当前时间戳
- `${KIMI_WORK_DIR}`: 工作目录
- `${KIMI_WORK_DIR_LS}`: 目录列表
- `${KIMI_AGENTS_MD}`: AGENTS.md 内容

## 环境变量

- `KIMI_BASE_URL`: 覆盖 API base URL
- `KIMI_API_KEY`: 覆盖 API key
- `KIMI_MODEL_NAME`: 覆盖模型名称
- `KIMI_MODEL_CAPABILITIES`: 覆盖模型能力

## 测试命令

```bash
# 运行所有测试
make test

# 运行特定测试
uv run pytest tests/test_bash.py -vv

# 运行特定测试函数
uv run pytest tests/test_bash.py::test_bash_command -vv

# 显示覆盖率
uv run pytest tests --cov=kimi_cli --cov-report=html
```

## 调试技巧

1. **启用调试日志**: `--debug` 选项
2. **查看日志**: `~/.kimi/logs/kimi.log`
3. **使用 `/debug` 命令**: 查看上下文状态
4. **检查会话历史**: `~/.kimi/sessions/{session_id}/history.jsonl`

## 常见问题

| 问题 | 解决方案 |
|------|---------|
| 导入错误 | 运行 `uv sync` |
| 配置错误 | 检查 `~/.kimi/config.json` |
| 工具加载失败 | 检查工具类路径和依赖注入 |
| API 错误 | 检查 API 密钥和网络连接 |
| 会话恢复失败 | 检查会话历史文件和工作目录 |

